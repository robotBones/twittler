<!DOCTYPE html>
<html>
  <head>
    <title>Twittler</title>
    <link rel="stylesheet" href="css/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="css/my.css">
  </head>
  <body class='container'>

    <nav class='navbar navbar-default navbar-fixed-top'>
      <div class='container'>
        <div class='row'>
          <div class=' col-lg-3 col-md-3 col-sm-4'>
            <h1 class='brand'>Twittler</h1>
            <div class='glyphicon glyphicon-home home'></div>
          </div>

          <div class="col-lg-6 col-md-6 col-sm-8">
            <div class="tweet-put input-group input-group-lg">
              <input type="text" class="form-control">
              <span class="input-group-btn">
                <button class="btn btn-default" type="button">Go!</button>
              </span>
            </div>
          </div>

        </div> <!-- end of row -->
      </div> <!-- end of container -->
    </nav> <!-- end of navbar -->

    <div class='main row'>

      <section class='timelineUser col-lg-3 col-md-3 col-sm-4'>
        <h2 class='tweeter'></h2>
      </section> <!-- end of timelineUser -->

      <section class='feed col-lg-6 col-md-6 col-sm-8'>
        <div class='tweet-box'>
          <a class='lead user' href="#"></a>
          <p class='message'></p>
          <p class='timeago text-right text-muted'>fv</p>
        </div> <!-- end of tweet-box -->
      </section> <!-- end of feed -->

      <div class='button col-lg-1 col-lg-offset-2 col-md-1 col-md-offset-2 toTop visible-lg visible-md'>
        <span class='glyphicon glyphicon-chevron-up'></span>
      </div>

    </div> <!-- end of main -->

    <script src="js/jquery.js"></script>
    <script src="js/data_generator.js"></script>
    <script src="js/underscore-min.js"></script>
    <script src="js/jquery.timeago.js"></script>
    <script>

      $(document).ready(function(){
        var $body = $('body');
        var $feed = $('.feed');
        var $home = $('.home');
        var $tweeter = $('.tweeter');
        var $toTop = $('.toTop');
        var times = document.getElementsByClassName('timeago');

        // keep track of view state.
        var inTimelineView = false;
        var glb_tweeter = "";

        // cloning & caching HTML for template and then deleting original HTML from DOM
        var $toClone = $('.tweet-box');
        var $tweetBox = $toClone.clone();
        $toClone.remove();

        // scroll to top
        $toTop.on('click', function() {
          $feed.stop().animate({scrollTop: 0});
        });

        // links to go back to main home view and remove timeline view state
        $('.brand, .home').on('click', function() {
          if (inTimelineView) {
            homeView();
          }
          $toTop.click();
        });

        // set inTimelineView to false, returning to main view
        var homeView = function() {
          inTimelineView = false;
          glb_tweeter = "";
          $tweeter.text("");
          $home.hide();
          displayTweets(streams.home);
        };

        // filter and display @user's tweet timeline
        var getTimeline = function(tweeter) {
          $tweeter.text(tweeter);
            displayTweets(streams.users[tweeter]);
        };

        // click listener display @user's timeline
        $feed.on('click', '.user', function(event){
          event.preventDefault();
          inTimelineView = true;
          var atUser = $(this).text();
          var user = atUser.slice(1);
          glb_tweeter = user;
          $home.show();
          getTimeline(user);
        });

        // background animation loop
        var animateCloud = function() {
          $body.animate({
            'background-position-x': '100%'
            }, 100000,
            'linear',
            function(){
              $body.css('background-position-x', '0%');
              animateCloud();
            });
        };

        // implement human readable time stamps via timeago.js
        var relTime = function(dateSource) {
          if (typeof dateSource === 'object') {
            return jQuery.timeago(dateSource.created_at);
          } else {
            return jQuery.timeago(dateSource);
          }
        };

        // construct HTML for tweets
        var buildTweet = function(tweetObj) {
          var $tweet = $tweetBox.clone();
          $tweet.find('.user').text('@' + tweetObj.user);
          $tweet.find('.message').text(tweetObj.message);
          $tweet.find('.timeago')
            .data("date", tweetObj.created_at)
            .text( relTime(tweetObj) );
          return $tweet;
        };

        // displaying initial tweets
        var displayTweets = function(tweetCollection) {
          $feed.html("");
          _.each(tweetCollection, function (tweet) {
            var $tweet = buildTweet(tweet);
            $tweet.prependTo($feed);
          });
        };

        var getLatestTweet = function() {
          return _.last(streams.home);
        };

        // animate in a new tweet
        var showTweet = function(tweetObj) {
          var tweetHTML = buildTweet(tweetObj);
          tweetHTML.prependTo($feed).hide();
          tweetHTML.slideDown();
        }

        // main loop to update tweets in view
        var mostRecent = _.last(streams.home).created_at;
        var seconds = 0;
        var updateTweetView = function() {
          setTimeout(function waitForTweet() {
            seconds += 1;
            var newest = getLatestTweet();
            // only show tweet if new.
            if ( newest.created_at !== mostRecent) {
              mostRecent = newest.created_at;
              if (inTimelineView && newest.user === glb_tweeter) {
                showTweet(newest);
              } else if (!inTimelineView) {
                  showTweet(newest);
              }
            }
            // update human readable timestamps every minute
            if (seconds === 60) {
              seconds = 0;
              _(times).each(function (el) {
                $el = $(el);
                date = +$el.data('date');
                $el.text( relTime(date) );
              });
            }
            updateTweetView();
          }, 1000);
        }

        $home.hide();
        displayTweets(streams.home);
        animateCloud();
        updateTweetView();

      });

    </script>
  </body>
</html>
