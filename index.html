<!DOCTYPE html>
<html>
  <head>
    <title>Twittler</title>
    <link rel="stylesheet" href="css/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="css/my.css">
    <script src="js/jquery.js"></script>
    <script src="js/data_generator.js"></script>
    <script src="js/underscore-min.js"></script>
    <script src="js/jquery.timeago.js"></script>
  </head>
  <body class='container'>
    <div class='navbar navbar-default navbar-fixed-top'>
      <div class='navbar-header'><h1>Twittler</h1></div>
    </div>
    <div class='main row'>
      <div class='test col-lg-3 col-md-3 col-sm-3'></div>
      <section class='feed col-lg-6 col-md-6 col-sm-6'>
        <div class='tweet-box'>
          <a class='lead user' href="#"></a>
          <p class='message'></p>
          <p class='timeago text-right text-muted'></p>
        </div>
      </section>
    </div>
      <div class='glyphicon glyphicon-chevron-up toTop visible-lg visible-md'></div>

    <script>

      $(document).ready(function(){
        var $body = $('body');
        var $feed = $('.feed');
        var times = document.getElementsByClassName('timeago');

        // cloning & caching HTML for template and then deleting original HTML from DOM
        var $toClone = $('.tweet-box');
        var $tweetBox = $toClone.clone();
        $toClone.remove();

        // scroll to top
        $('.toTop').click(function() {
          $('.feed').stop().animate({scrollTop: 0});
        });

        // background animation
        var animateCloud = function() {
          $body.animate({
            'background-position-x': '100%'
            }, 100000,
            'linear',
            function(){
              $body.css('background-position-x', '0%');
              animateCloud();
            });
        };

        var relTime = function(dateSource) {
          if (typeof dateSource === 'object') {
            return jQuery.timeago(dateSource.created_at);
          } else {
            return jQuery.timeago(dateSource);
          }
        };

        var buildTweet = function(tweetObj) {
          var $tweet = $tweetBox.clone();
          $tweet.find('.user').text('@' + tweetObj.user);
          $tweet.find('.message').text(tweetObj.message);
          $tweet.find('.timeago')
            .data("date", tweetObj.created_at)
            .text( relTime(tweetObj) );
          return $tweet;
        };

        // displaying initial tweets
        var index = streams.home.length - 1;
        while(index >= 0){
          var tweet = streams.home[index];
          var $tweet = buildTweet(tweet);
          $tweet.appendTo($feed);
          index -= 1;
        }

        var getLatestTweet = function() {
          return _.last(streams.home);
        };


        var showTweet = function(tweetObj) {
          var tweetHTML = buildTweet(tweetObj);
          tweetHTML.prependTo($feed).hide();
          tweetHTML.slideDown();
        }

        var mostRecent = _.last(streams.home).created_at;
        var seconds = 0;
        var updateTweetView = function() {
          setTimeout(function waitForTweet() {
            seconds += 1;
            var newest = getLatestTweet();
            // only show tweet if new.
            if ( newest.created_at !== mostRecent) {
              mostRecent = newest.created_at;
              showTweet(newest);
            }
            if (seconds === 60) {
              seconds = 0;
              _(times).each(function (el) {
                $el = $(el);
                date = +$el.data('date');
                $el.text( relTime(date) );
              });
            }
            updateTweetView();
          }, 1000);
        }

        animateCloud();
        updateTweetView();

      });

    </script>
  </body>
</html>
