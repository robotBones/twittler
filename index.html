<!DOCTYPE html>
<html>
  <head>
    <title>Twittler</title>
    <link rel="stylesheet" href="css/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="css/my.css">
  </head>
  <body class='container'>

    <nav class='navbar navbar-default navbar-fixed-top'>
      <div class='container'>
        <div class='row'>

          <div class=' col-lg-3 col-md-3 col-sm-4'>
            <h1 class='brand'>Twittler</h1>
            <div class='glyphicon glyphicon-home home'></div>
          </div> <!-- end of brand logo and home link -->

          <div class="col-lg-6 col-md-6 col-sm-8">
            <div class="tweet-put-group input-group input-group-lg">
              <input type="text" class="form-control tweet-put" name='incomingTweet' placeholder='thought vomit goes here'>
              <span class="input-group-btn">
                <button class="send btn btn-default" type="button">Flush</button>
              </span>
            </div>
          </div> <!-- end of input-group -->

        </div> <!-- end of row -->
      </div> <!-- end of container -->
    </nav> <!-- end of navbar -->

    <div class='main row'>

      <section class='timelineUser col-lg-3 col-md-3 col-sm-4'>
        <h2 class='tweeter'></h2>
      </section> <!-- end of timelineUser -->

      <section class='feed col-lg-6 col-md-6 col-sm-8'>
        <div class='tweet-box'>
          <a class='lead user' href="#">@YourMom...</a>
          <p class='message'>Light Bulb flickering...</p>
          <p class='timeago text-right text-muted'>Time is an Ocean...</p>
        </div>    <!-- end of tweet-box -->
      </section> <!-- end of feed -->

      <div class='toTop btn-glass col-lg-1 col-lg-offset-2 col-md-1 col-md-offset-2 visible-lg visible-md'>
        <span class='glyphicon glyphicon-chevron-up'></span>
      </div> <!-- end of scroll-to-top button -->

    </div> <!-- end of main -->

    <script src="js/jquery.js"></script>
    <script src="js/data_generator.js"></script>
    <script src="js/underscore-min.js"></script>
    <script src="js/jquery.timeago.js"></script>
    <script>

      $(document).ready(function() {
        var $bg = $('body');
        var $overflow = $('html, body');
        var $feed = $('.feed');
        var $homeBtn = $('.home');
        var $tweeter = $('.tweeter');
        var $toTop = $('.toTop');
        var $tweetPut = $('.tweet-put')
        var $sendBtn = $('.send');
        var timeEls = document.getElementsByClassName('timeago');
        window.visitor = 'YourMom';
        streams.users[visitor] = [];

        // keep track of view state.
        var inTimelineView = false;
        var userToStalk = "";

        // cloning & caching HTML for template and then deleting original HTML from DOM
        // because mixing HTML in javascript confuses me.
        var $toClone = $('.tweet-box');
        var $tweetBox = $toClone.clone();
        $toClone.remove();

        // scroll to top
        $toTop.on('click', function() {
          $overflow.stop().animate({scrollTop:0}, 'swing');
          animateCloud();
        });

        // click listener display @user's timeline
        $feed.on('click', '.user', function (event){
          event.preventDefault();
          // extract @user and remove "@"
          userToStalk = $(this).text().slice(1);
          // change the view
          inTimelineView = true;
          $homeBtn.show();
          toTimelineView(userToStalk);
        });

        // links to go back to main home view and remove timeline view state.
        // it leverages the click listener already on $toTop.
        $('.brand, .home').on('click', function() {
          if (inTimelineView) {
            toHomeView();
          }
          $toTop.click();
        });

        // for sending tweets
        $sendBtn.on('click', function (event) {
          event.preventDefault();

          var input = $tweetPut.val();
          if (input === "") {
            $tweetPut.attr('placeholder', "write something").focus();
          } else {
            writeTweet(input);
            // adding creation date to added date after it's tweet obj is created which
            // I think should have been in writeTweet() to begin with.
            _.last(streams.users[visitor]).created_at = new Date();
            $tweetPut.attr('placeholder', "Please, may I have another?").val("").focus();
          }
        });

        $tweetPut.on('keyup', function (event) {
          event.stopPropagation();
          if (event.keyCode === 13) { // Enter key
            $sendBtn.click();
          }
        });

        // set inTimelineView to false, returning to main view
        var toHomeView = function() {
          inTimelineView = false;
          userToStalk = "";
          $tweeter.text("");
          $homeBtn.hide();
          displayTweets(streams.home);
        };

        // filter and display @user's tweet timeline
        var toTimelineView = function(tweeter) {
          $tweeter.text(tweeter);
            displayTweets(streams.users[tweeter]);
        };

        // background animation loop. Only in webkit.
        var animateCloud = function() {
          $bg.animate({
            'background-position-x': '100%'
            }, 100000,
            'linear',
            function(){
              $bg.css({'background-position-x': '0%'});
              animateCloud();
            });
        };

        // implement human readable time stamps via timeago.js
        var useTimeago = function(dateSource) {
          if (typeof dateSource === 'object') {
            //timeago() won't take a date object
            return jQuery.timeago(dateSource.created_at);
          } else {
            return jQuery.timeago(dateSource);
          }
        };

        // construct HTML for tweets
        var buildTweet = function(tweetObj) {
          var $tweet = $tweetBox.clone();
          $tweet.find('.user').text('@' + tweetObj.user);
          $tweet.find('.message').text(tweetObj.message);
          $tweet.find('.timeago')
            .data("date", tweetObj.created_at)// this
            .text( useTimeago(tweetObj) );
          return $tweet;
        };

        // displaying initial tweets
        var displayTweets = function(tweetCollection) {
          $feed.html("");
          _.each(tweetCollection, function (tweet) {
            var $tweet = buildTweet(tweet);
            $tweet.prependTo($feed);
          });
        };

        var mostRecent = _.last(streams.home).created_at;
        var getLatestTweets = function() {
          var newTweets = [];
          for (var i = streams.home.length-1; i >= 0; i--) {
            if (streams.home[i].created_at > mostRecent) {
              newTweets.unshift(streams.home[i]);
            }
            else {
              break;
            }
          }
          mostRecent = _.last(streams.home).created_at;
          return newTweets;
        };

        // animate in a new tweet
        var showTweet = function(tweetObj) {
          var tweetHTML = buildTweet(tweetObj);
          tweetHTML.prependTo($feed).hide();
          tweetHTML.slideDown();
        }

        // main loop to update tweets in view
        var lastTime = new Date();
        var thisTime = new Date();
        var updateTweetView = function() {
          setTimeout(function waitForTweet() {
            var newest = getLatestTweets();
            // only show tweet if new.
            _(newest).each(function (newTweet) {
              if (inTimelineView && newTweet.user === userToStalk) {
                showTweet(newTweet);
              } else if (!inTimelineView) {
                showTweet(newTweet);
              }
            });
            // update human readable timestamps every minute
            thisTime = new Date();
            if (thisTime - lastTime >= 60000) {
              _(timeEls).each(function (el) {
                $el = $(el);
                //jQuery.timeago.js won't take a date object.
                date = +$el.data('date');
                $el.text( useTimeago(date) );
                lastTime = thisTime;
              });
            }
            updateTweetView();
          }, 1000);
        }

        // invoking application
        $homeBtn.hide();
        displayTweets(streams.home);
        animateCloud();
        updateTweetView();

      });

    </script>
  </body>
</html>
